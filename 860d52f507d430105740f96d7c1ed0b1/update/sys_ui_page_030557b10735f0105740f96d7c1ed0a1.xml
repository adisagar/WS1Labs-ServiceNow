<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_ui_page">
    <sys_ui_page action="INSERT_OR_UPDATE">
        <category>general</category>
        <client_script><![CDATA[onLoad();

function onLoad() {
	//set the value in the fields to existing values
	var oauth_table = new GlideRecord('oauth_entity');
	oauth_table.addQuery('name', "WorkspaceOneUEM Assist OAuth Provider");
	oauth_table.query();
	if (oauth_table.next()) {
		var clientid = oauth_table.client_id;
//		don't retrieve the existing client secret but just set it to a temp value;
		var clientsecret = "clientsecret";
		var tokenurl = oauth_table.token_url;

		$("input_ws1_clientid").value = clientid;
		$("input_ws1_clientsecret").value = clientsecret;
		$("input_ws1_tokenurl").value = tokenurl;
	}	
	
	var http_table = new GlideRecord('http_connection');
	http_table.addQuery('name', "WorkspaceOneUEM Assist OAuth Credentials");
	http_table.query();
	if (http_table.next()) {
		var hostid = http_table.host;	
		$("input_ws1_hostid").value = hostid;
	}
}

// function to get the values from the existing oauth record
// the aim is to collect these in the HTML and update them here
function setValues() {
	var clientid = gel('input_ws1_clientid').value;
	var clientsecret = gel('input_ws1_clientsecret').value;
	var tokenurl = gel('input_ws1_tokenurl').value;
	var hostid = gel('input_ws1_hostid').value;
	
	var oauth_table = new GlideRecord('oauth_entity');
	oauth_table.addQuery('name', "WorkspaceOneUEM Assist OAuth Provider");
	oauth_table.query();
	if (oauth_table.next()) {
		oauth_table.client_id = clientid;

		// if the client secret hasn't changed then don't update it
		if (clientsecret != "clientsecret") {
			oauth_table.client_secret = clientsecret;
		}
		
		oauth_table.token_url = tokenurl;
		oauth_table.update();
	}
	
	var http_table = new GlideRecord('http_connection');
	http_table.addQuery('name', "WorkspaceOneUEM Assist OAuth Credentials");
	http_table.query();
	if (http_table.next()) {
		http_table.host = hostid;		
		http_table.update();
	}
	
	// get the oauth token
	testoauth();
}


// test the details are correct by getting the OAuth token
function testoauth () {
	var oauth_initiator_url = '';
	var oauth_table = new GlideRecord('oauth_2_0_credentials');
	oauth_table.addQuery('name', "WorkspaceOneUEM Assist OAuth Credentails");
	oauth_table.query();
	if (oauth_table.next()) {
		var oauthProfileId = oauth_table.oauth_entity_profile;	
		var oauthRequestorSysId = oauth_table.sys_id;
		var oauthRequestorContext = 'oauth_2_0_credentials';

		oauth_initiator_url = '/oauth_client_credentials_input.do' +
		'?sysparm_oauth_requestor_context=' + oauthRequestorContext +
		'&sysparm_oauth_requestor=' + oauthRequestorSysId +
		'&sysparm_oauth_provider_profile=' + oauthProfileId;
		
		window.open(oauth_initiator_url, '', 'height=500,width=800'); // pops up window
	}
}

]]></client_script>
        <description>Configure the connection to Workspace ONE UEM</description>
        <direct>false</direct>
        <endpoint>x_vmw_uemconn_0_WS1UEMConfigureConnection.do</endpoint>
        <html><![CDATA[<?xml version="1.0" encoding="utf-8" ?>
<j:jelly trim="false" xmlns:j="jelly:core" xmlns:g="glide" xmlns:j2="null" xmlns:g2="null">
    <g:ui_form>
		
	<input type="hidden" id="runprocessingscript" name="runprocessingscript" value=""/>
	<div style="margin-left:10px; margin-top:10px" id="div_ws1_hostid" >
		<span style="display:inline-block; width:40%">
			<g:form_label>
				${gs.getMessage('WS1UEMHostnameAPI')}
			</g:form_label>
		</span>	
	</div>
	<div style="margin-left:10px; margin-bottom:30px;" id="div_ws1_hostid_input" >
		<input type="text" name="input_ws1_hostid" id="input_ws1_hostid" table="http_connection" field="host" query="active=true" minlength="1" size="50"/>	
	</div>
		
				
	<div style="margin-left:10px" id="div_ws1_clientid" >
		<span style="display:inline-block; width:40%">
			<g:form_label>
				${gs.getMessage('WS1UEMClientId')}
			</g:form_label>
		</span>	
	</div>
	<div style="margin-left:10px; margin-bottom:30px" id="div_ws1_clientid_input" >
		<input type="text" name="input_ws1_clientid" id="input_ws1_clientid" table="oauth_table" field="client_id" query="active=true" minlength="1" size="50"/>	
	</div>
		
		
	<div style="margin-left:10px" id="div_ws1_clientsecret" >
		<span style="display:inline-block; width:40%">
			<g:form_label>
				${gs.getMessage('WS1UEMClientSecret')}
			</g:form_label>
		</span>	
	</div>
	<div style="margin-left:10px; margin-bottom:30px" id="div_ws1_clientsecret_input" >
		<input type="password" name="input_ws1_clientsecret" id="input_ws1_clientsecret" table="oauth_table" field="client_secret" query="active=true" minlength="1" size="50"/>	</div>
		
		
	<div style="margin-left:10px" id="div_ws1_tokenurl" >
		<span style="display:inline-block; width:40%">
			<g:form_label>
				${gs.getMessage('WS1UEMTokenURL')}
			</g:form_label>
		</span>	
	</div>
	<div style="margin-left:10px; margin-bottom:30px" id="div_ws1_token_input_input" >
		<input type="text" name="input_ws1_tokenurl" id="input_ws1_tokenurl" table="oauth_table" field="token_url" query="active=true" minlength="1" size="50"/>		
	</div>
		
		
	<div style="margin:10px" id="div_ws1_test" >
		<span style="display:inline-block; width:40%">
			<g:form_label>
				<button type="submit" onclick="setValues()">${gs.getMessage('WS1UEMGetToken')}</button>
			</g:form_label>
		</span>	
	</div>

	</g:ui_form>
</j:jelly>]]></html>
        <name>WS1UEMConfigureConnection</name>
        <processing_script><![CDATA[	
]]></processing_script>
        <sys_class_name>sys_ui_page</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2021-08-07 01:22:27</sys_created_on>
        <sys_id>030557b10735f0105740f96d7c1ed0a1</sys_id>
        <sys_mod_count>52</sys_mod_count>
        <sys_name>WS1UEMConfigureConnection</sys_name>
        <sys_package display_value="WS1UEM" source="x_vmw_uemconn_0">860d52f507d430105740f96d7c1ed0b1</sys_package>
        <sys_policy/>
        <sys_scope display_value="WS1UEM">860d52f507d430105740f96d7c1ed0b1</sys_scope>
        <sys_update_name>sys_ui_page_030557b10735f0105740f96d7c1ed0a1</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2021-08-26 04:20:16</sys_updated_on>
    </sys_ui_page>
</record_update>
